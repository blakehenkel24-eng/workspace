/**
 * Slide Rendering Service
 * Handles image generation from slide content
 */

const nodeHtmlToImage = require('node-html-to-image');
const fs = require('fs').promises;
const path = require('path');
const config = require('../config');
const { escapeXml } = require('../utils/helpers');

// Track if Puppeteer is available
let puppeteerAvailable = true;

// Slide dimensions
const { width: SLIDE_WIDTH, height: SLIDE_HEIGHT, scaleFactor } = config.slides.dimensions;

/**
 * Build slide HTML based on type
 */
function buildSlideHTML(slideType, content) {
  const slideBuilders = require('./slide-templates');
  const bodyHTML = slideBuilders.buildSlideBody(slideType, content);
  const styles = slideBuilders.getSlideStyles();
  
  return `
    <!DOCTYPE html>
    <html>
    <head>
      <meta charset="UTF-8">
      <style>${styles}</style>
    </head>
    <body>
      ${bodyHTML}
    </body>
    </html>
  `;
}

/**
 * Generate placeholder SVG as fallback
 */
function generatePlaceholderSVG(content, slideType) {
  const title = escapeXml(content.title || 'Consulting Slide');
  const subtitle = escapeXml(content.subtitle || '');
  
  return `<svg xmlns="http://www.w3.org/2000/svg" width="${SLIDE_WIDTH}" height="${SLIDE_HEIGHT}" viewBox="0 0 ${SLIDE_WIDTH} ${SLIDE_HEIGHT}">
    <rect width="100%" height="100%" fill="#fafafa"/>
    <rect x="80" y="60" width="${SLIDE_WIDTH - 160}" height="4" fill="#0d2137"/>
    <text x="80" y="130" font-family="Arial, sans-serif" font-size="52" font-weight="bold" fill="#0d2137">${title}</text>
    ${subtitle ? `<text x="80" y="190" font-family="Arial, sans-serif" font-size="28" fill="#52525b">${subtitle}</text>` : ''}
    <rect x="80" y="280" width="800" height="200" rx="8" fill="#f4f4f5"/>
    <text x="100" y="340" font-family="Arial, sans-serif" font-size="18" fill="#71717a">Slide Type: ${slideType}</text>
    <text x="100" y="380" font-family="Arial, sans-serif" font-size="16" fill="#a1a1aa">Generated by SlideTheory</text>
    <text x="100" y="420" font-family="Arial, sans-serif" font-size="16" fill="#a1a1aa">Note: Install Chromium for full image rendering</text>
    <text x="${SLIDE_WIDTH - 80}" y="${SLIDE_HEIGHT - 60}" font-family="Arial, sans-serif" font-size="14" fill="#a1a1aa" text-anchor="end">Confidential</text>
  </svg>`;
}

/**
 * Render slide to image file
 */
async function renderSlideToImage({ slideType, content, outputPath }) {
  const html = buildSlideHTML(slideType, content);
  
  // Ensure output directory exists
  const outputDir = path.dirname(outputPath);
  await fs.mkdir(outputDir, { recursive: true });
  
  // If we already know Puppeteer isn't available, skip to fallback
  if (!puppeteerAvailable) {
    console.log('[SlideRenderer] Using fallback SVG rendering (Puppeteer unavailable)');
    const svg = generatePlaceholderSVG(content, slideType);
    const svgPath = outputPath.replace('.png', '.svg');
    await fs.writeFile(svgPath, svg);
    return svgPath;
  }
  
  try {
    // Generate image using node-html-to-image
    await nodeHtmlToImage({
      html,
      output: outputPath,
      puppeteerArgs: {
        defaultViewport: {
          width: SLIDE_WIDTH,
          height: SLIDE_HEIGHT,
          deviceScaleFactor: scaleFactor
        },
        args: [
          '--no-sandbox',
          '--disable-setuid-sandbox',
          '--disable-dev-shm-usage',
          '--disable-gpu'
        ]
      },
      type: 'png'
    });
    
    return outputPath;
  } catch (error) {
    console.error('[SlideRenderer] Puppeteer error:', error.message);
    
    // Mark Puppeteer as unavailable for future requests
    if (error.message.includes('Failed to launch') || error.message.includes('browser')) {
      puppeteerAvailable = false;
      console.log('[SlideRenderer] Switching to fallback SVG rendering mode');
    }
    
    // Fallback: Generate SVG placeholder
    const svg = generatePlaceholderSVG(content, slideType);
    const svgPath = outputPath.replace('.png', '.svg');
    await fs.writeFile(svgPath, svg);
    
    return svgPath;
  }
}

module.exports = {
  renderSlideToImage,
  buildSlideHTML,
  generatePlaceholderSVG
};
